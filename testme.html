<!DOCTYPE html>
<html>
<head>
  <title>Test Cases for Runtime Features</title>
</head>
<body>
  <script type="module">
    const log = (label, val) => console.log(`<__log> '${label}'`, val);

    // TC1: setTimeout and clearTimeout
    const timeoutId = setTimeout(() => {
      console.log("TIMEOUT HAPPENED"); // should not be seen
    }, 500);
    clearTimeout(timeoutId);

    // TC2: setInterval and clearInterval
    const intervalId = setInterval(() => {
      console.log("<__log> 'INTERVAL HAPPENED'");
      clearInterval(intervalId); // run only once
    }, 200);

    // TC3: queueMicrotask
    let microtaskFired = false;
    queueMicrotask(() => {
      microtaskFired = true;
      log("Microtask fired:", microtaskFired);
    });

    // TC4: atob and btoa
    const ao = "Hello World!";
    const bo = btoa(ao);
    log("ao", ao);
    log("bo", bo);

    // TC5: Buffer conversion
    const buf = Buffer.from("hello", "utf8");
    log("data", buf);
    log("decoded", buf.toString("utf8"));
    const unbuf = new TextDecoder().decode(new Uint8Array([104, 101, 108, 108, 111]));
    log("unbuf", unbuf);

    // TC6: URL and TC7: URLSearchParams
    const url = new URL("https://example.com/path?foo=1&bar=2");
    const params = new URLSearchParams(url.search);
    log("Host:", url.hostname);
    log("Pathname:", url.pathname);
    log("Has foo:", params.has("foo"));
    log("Value of bar:", params.get("bar"));
    params.set("baz", "42");
    log("New search:", params.toString());

    // TC8: util.inspect
    import('node:util').then(util => {
      const inspected = util.inspect({ hello: "world" });
      log("Inspected:", inspected);
    });

    // TC9: crypto.createHash / createHmac / randomBytes
    import('node:crypto').then(crypto => {
      const hash = crypto.createHash('sha256').update('test').digest('hex');
      const hmac = crypto.createHmac('sha256', 'key').update('test').digest('hex');
      const random = crypto.randomBytes(8).toString('hex');
      log("SHA-256 Hash:", hash);
      log("HMAC:", hmac);
      log("Random Bytes:", random);

      // TC10: crypto.generateKeyPairSync
      const { publicKey, privateKey } = crypto.generateKeyPairSync('rsa', {
        modulusLength: 512,
        publicKeyEncoding: { type: 'spki', format: 'pem' },
        privateKeyEncoding: { type: 'pkcs8', format: 'pem' }
      });
      log("Public Key:", publicKey.split('\n')[0] + '\\n' + publicKey.split('\n')[1]);
      log("Private Key:", privateKey.split('\n')[0] + '\\n' + privateKey.split('\n')[1]);

      // TC11: crypto.webcrypto.subtle
      const subtle = crypto.webcrypto.subtle;
      const enc = new TextEncoder().encode("secret data");
      subtle.digest("SHA-256", enc).then(d => {
        log("Subtle Digest:", Buffer.from(d).toString('hex'));
      });
    });

  </script>
</body>
</html>
